<%- include('../../views/partials/user/header') %>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body{
      margin-top: 150px;
    }
    :root {
      --brand: #ff4646;
      --brand-light: #ffecec;
    }

    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }

    .orders-container {
      margin: auto;
      
    }

    .page-title {
      color: var(--brand);
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
    }

    .orders-list {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .order-header {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr 1fr 1fr;
      padding: 15px 20px;
      background-color: var(--brand-light);
      font-weight: 600;
      color: #333;
      border-radius: 10px 10px 0 0;
    }
    .text-muted{
      color: gray;
      margin-left: 5px;
    }

    .order-item {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr 1fr 1fr;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }

    .order-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
   .action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .view-more-btn {
    color: var(--brand);
    background: none;
    border: 1px solid var(--brand);
    padding: 6px 12px;
    border-radius: 5px;
    font-size: 0.85rem;
    transition: all 0.2s ease-in-out;
    width: fit-content;
  }
  
  .view-more-btn:hover {
    background-color: var(--brand);
    color: white;
  }
    .order-info img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .product-title {
      font-weight: 500;
      color: #333;
      margin-bottom: 3px;
    }

    .order-id {
      font-size: 0.85rem;
      color: #666;
      font-weight: 600;
    }

    .product-price {
      font-weight: 500;
    }

    .product-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      text-align: center;
      width: fit-content;
    }

    .status-processing {
      background-color: #089ae9;
      color: #fbfafa;
    }

    .status-shipped {
      background-color: #cce5ff;
      color: #004085;
    }
    .status-Returned{
      background-color: #055ef6;
      color: white;
    }
    .status-Return-Requested{
      background-color: #7dd291;
      color: white;
    }

    .status-delivered {
      background-color: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background-color: #ff0a1e;
      color: #fafafa;
    }

    .cancel-btn {
      border: 1px solid var(--brand);
      color: var(--brand);
      background-color: transparent;
      padding: 6px 12px;
      border-radius: 5px;
      font-size: 0.85rem;
      transition: all 0.2s ease-in-out;
      width: fit-content;
    }

    .cancel-btn:hover {
      background-color: var(--brand);
      color: white;
    }


    .no-orders {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    @media (max-width: 768px) {
      .order-header {
        display: none;
      }

      .order-item {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 20px;
      }

      .order-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .product-status {
        margin: 5px 0;
      }
    }
     .sidebar {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
  .profile-card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    .profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
    }

    .sidebar .nav-link {
      color: #333;
      font-weight: 500;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .sidebar .nav-link.active,
    .sidebar .nav-link:hover {
      background-color: #ff4646;
      color: #fff;
    }

  
  .pagination {
    justify-content: center;
    margin-top: 30px;
  }
  
  .page-item.active .page-link {
    background-color: var(--brand);
    border-color: var(--brand);
  }
  
  .page-link {
    color: var(--brand);
  }
  
  .view-more-btn {
    color: var(--brand);
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    padding: 0;
    text-decoration: underline;
  }
  
  .hidden-items {
    display: none;
  }
</style>
<body>
  
  <div class="container my-4 px-3 px-md-4">
    <div class="row g-4 flex-column flex-md-row">
        <div class="container my-4 px-3 px-md-4">
  <div class="row g-4 flex-column flex-md-row">
   
    <div class="col-md-3">
      <div class="sidebar">
        <div class="text-center mb-3">
          <img src="<%= user?.profileImage %>" class="profile-pic" alt="User">
         <h6 class="mt-2 mb-0">Welcome,<%=user.firstname%></h6>
          <small class="text-muted"><%=user.email%></small>
        </div>
        <nav class="nav flex-column">
          <a class="nav-link " href="user-profile"><i class="fas fa-gauge me-2"></i> Dashboard</a>
          <a class="nav-link " href="edit-profile"><i class="fas fa-user-edit me-2"></i> Edit Profile</a>
          <a class="nav-link active" href="view-orders"><i class="fas fa-box me-2"></i> My Orders</a>
          <a class="nav-link " href="/user-address"><i class="fas fa-map-marker-alt me-2"></i> My Address</a>
          <a class="nav-link" href="#"><i class="fas fa-wallet me-2"></i> My Wallet</a>
          <!-- <a class="nav-link" href="#"><i class="fas fa-key me-2"></i> Change Password</a> -->
        </nav>
      </div>
    </div>
      
      <div class="orders-container py-4 col-md-9">
        <div class="orders-list">
          <div class="order-header">
            <div>Order ID</div>
            <div>Product</div>
            <div>Amount</div>
            <div>Status</div>
            <div>Action</div>
          </div>

          <% if (orders.length > 0) { %>
            <% orders.forEach(order => { %>
              <% let itemsToShow = 1; %>
              <% order.orderedItems.forEach((item, index) => { %>
                <div class="order-item <%= index >= itemsToShow ? 'hidden-items' : '' %>" data-order-id="<%= order.orderId %>">
                  <div class="order-id"><%= order.orderId %></div>
                  <div class="order-info">
                    <img src="<%= item.product?.images[0] || '/default-product.png' %>" alt="<%= item.product?.name || 'Product' %>"/>
                    <div>
                      <div class="product-title">
                        <%= item.product?.productName || 'Unnamed Product' %>
                        <span class="text-muted"> x<%= item.quantity %></span>
                      </div>
                      <% if (item.variant) { %>
                        <div class="product-variant">
                          Color: <%= item.variant.color %>, Storage: <%= item.variant.storage %>
                        </div>
                      <% } else { %>
                        <div class="product-variant text-muted">No variant info</div>
                      <% } %>
                    </div>
                  </div>
                  <div class="product-price">
                    â‚¹<%= item.discountPrice || item.price %>
                  </div>
                 <div class="product-status 
  <%= order.status === 'Processing' ? 'status-processing' :
      order.status === 'Confirmed' ? 'status-confirmed' :
      order.status === 'Shipped' ? 'status-shipped' :
      order.status === 'Delivered' ? 'status-delivered' :
      order.status === 'Returned' ? 'status-Returned' :
      order.status === 'Return Requested' ? 'status-Return-Requested' :
      'status-cancelled' %>">
  <%= order.status %>
</div>

                 <div class="d-flex gap-2">
 <% if (order.status !== 'Cancelled') { %>
  <button class="btn btn-danger btn-sm" onclick="deleteOrder('<%= order._id %>', this)">Cancel</button>
<% } else { %>
  <button class="btn btn-secondary btn-sm" disabled>Cancelled</button>
<% } %>

  <a href="/orders-details/<%= order._id %>" class="btn btn-outline-primary btn-sm">view more</a>
</div>

 
                </div>
              <% }) %>
              
              <% if (order.orderedItems.length > 1) { %>
                <div class="text-center my-2">
                 
                </div>
              <% } %>
            <% }) %>
            
            <!-- Pagination -->
            <% if (totalPages > 1) { %>
              <nav aria-label="Page navigation">
                <ul class="pagination">
                  <% if (hasPreviousPage) { %>
                    <li class="page-item">
                      <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                      </a>
                    </li>
                  <% } %>
                  
                  <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                      <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                    </li>
                  <% } %>
                  
                  <% if (hasNextPage) { %>
                    <li class="page-item">
                      <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                      </a>
                    </li>
                  <% } %>
                </ul>
              </nav>
            <% } %>
          <% } else { %>
            <div class="no-orders">
              <p>You haven't placed any orders yet.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    function toggleItems(orderId) {
      const items = document.querySelectorAll(`.order-item[data-order-id="${orderId}"]`);
      const button = document.querySelector(`.view-more-btn[onclick="toggleItems('${orderId}')"]`);
      
      items.forEach(item => {
        if (item.classList.contains('hidden-items')) {
          item.classList.remove('hidden-items');
          button.textContent = 'Show less items';
        } else if (item !== items[0]) {
          item.classList.add('hidden-items');
          button.textContent = `View all ${items.length} items`;
        }
      });
    }
async function deleteOrder(orderId, button) {
  const confirmResult = await Swal.fire({
    title: 'Are you sure?',
    text: "Do you want to cancel this order?",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ff4646',
    cancelButtonColor: '#aaa',
    confirmButtonText: 'Yes, cancel it!',
  });

  if (confirmResult.isConfirmed) {
    try {
      const response = await fetch(`/order-cancel/${orderId}`, {
        method: 'get',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const result = await response.json();

      if (result.success) {
        
        const orderElement = button.closest('.order-item');
        const statusElement = orderElement.querySelector('.product-status');
        if (statusElement) {
          statusElement.textContent = 'Cancelled';
          statusElement.className = 'product-status status-cancelled';
        }

        
        button.disabled = true;
        button.textContent = 'Cancelled';

        await Swal.fire(
          'Cancelled!',
          'Your order has been marked as cancelled.',
          'success'
        );
      } else {
        Swal.fire('Failed!', 'Could not cancel the order.', 'error');
      }
    } catch (err) {
      console.error('Error:', err);
      Swal.fire('Oops!', 'Something went wrong.', 'error');
    }
  }
}

  </script>
</body>
<%- include('../../views/partials/user/footer') %>