<%- include('../../views/partials/user/header') %>

<style>
 
  .product-detail-page .container {
      max-width: 1200px;
      margin: 100px auto;
      padding: 0 20px;
      font-family: 'Segoe UI', sans-serif;
    }

    .related-products-section {
    margin-top: 60px;
    padding: 0 20px;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .related-products-section h2 {
    font-size: 1.5em;
    margin-bottom: 20px;
    color: #333;
  }
  
  .related-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 20px;
  }
  
  .related-product-card {
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .related-product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .related-product-image {
    width: 100%;
    height: 180px;
    object-fit: contain;
    background: #f9f9f9;
  }
  
  .related-product-info {
    padding: 12px;
  }
  
  .related-product-name {
    font-size: 0.95em;
    margin: 0 0 8px 0;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .related-product-price {
    color: #1e918b;
    font-weight: bold;
    font-size: 1em;
  }
  
  @media (max-width: 768px) {
    .related-products-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .related-product-image {
      height: 150px;
    }
  }
    .product-main {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }

  .related-products-list {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  .related-product-card {
    border: 1px solid #eee;
    border-radius: 8px;
    width: 180px;
    text-align: center;
    background: #fafafa;
    transition: box-shadow 0.2s;
  }
  .related-product-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .related-product-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
  }
  .related-product-info {
    padding: 0.5rem;
  }
  .related-product-name {
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }
  .related-product-price {
    color: #388e3c;
    font-weight: bold;
  }



    .gallery {
      flex: 1;
      min-width: 300px;
      display: flex;
      gap: 20px;
    }

    .thumbnails {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border: 2px solid transparent;
      cursor: pointer;
      border-radius: 6px;
    }

    .thumbnail.active {
      border-color: #1e918b;
    }

    .main-image-box {
      flex: 1;
    }

    .main-image-box img {
      width: 100%;
      max-height: 450px;
      object-fit: contain;
      border-radius: 8px;
    }

    .details {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .details h1 {
      font-size: 2em;
      margin: 0;
    }

    .short-desc {
      color: #555;
      line-height: 1.5;
    }

    .price {
      font-size: 1.5em;
      font-weight: bold;
      color: #1e918b;
    }

    .out-of-stock {
      color: #ff4646;
      font-weight: bold;
    }

    .ratings {
      color: #ffc107;
      font-size: 0.95em;
    }

    .variant-group {
      margin-bottom: 1rem;
    }
    .old-price{
text-decoration:line-through;
    }

    .variant-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .color-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .color-options input[type="radio"] {
      display: none;
    }

    .color-button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
    }

    .color-options input[type="radio"]:checked + .color-button {
      background: #1e918b;
      color: white;
      border-color: #1e918b;
    }

    .color-options input[type="radio"]:disabled + .color-button {
      opacity: 0.5;
      cursor: not-allowed;
      text-decoration: line-through;
    }

    .storage-select {
      padding: 8px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 100%;
    }

    .storage-select option:disabled {
      color: #ccc;
    }

    .action-buttons {
      display: flex;
      gap: 16px;
      margin-top: 1rem;
    }

    .buy-now,
    .add-to-basket {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .buy-now {
      background-color: #ff4646;
      color: white;
    }

    .buy-now:hover {
      background-color: #07eb88;
    }

    .add-to-basket {
      background-color: #080808;
      color: #ffffff;
    }

    .add-to-basket:hover {
      background-color:  #07eb88;
    }

    .action-buttons button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .delivery {
      font-size: 0.9em;
      color: #666;
      margin-top: 1rem;
    }

    .delivery a {
      font-size: 0.85em;
      color: #007bff;
      text-decoration: underline;
    }

    .similar-products {
      margin-top: 60px;
    }

    .similar-products h2 {
      font-size: 1.5em;
      margin-bottom: 20px;
    }

    .similar-grid {
      display: flex;
      gap: 24px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .product-card {
      width: 180px;
      flex-shrink: 0;
      background: #fff;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 16px;
      transition: transform 0.2s ease;
    }

    .product-card:hover {
      transform: translateY(-5px);
    }

    .product-card img {
      width: 100%;
      height: 150px;
      object-fit: contain;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .product-card .name {
      font-size: 0.9em;
      color: #333;
      margin: 8px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-card .price {
      font-weight: bold;
      color: #1e918b;
      font-size: 1em;
    }

    .product-not-found {
      text-align: center;
      padding: 40px 0;
    }
    .magnifier-glass {
  position: absolute;
  border: 2px solid #1e918b;
  border-radius: 50%;
  cursor: none;
  /* Size of magnifier glass: */
  width: 120px;
  height: 120px;
  opacity: 0;
  pointer-events: none;
  box-shadow: 0 2px 8px rgba(30,145,139,0.15);
  background-repeat: no-repeat;
  background-position: center;
  z-index: 10;
  transition: opacity 0.2s;
}
.main-image-box {
  position: relative;
}


    @media (max-width: 768px) {
      .product-main {
        flex-direction: column;
        gap: 30px;
      }
      
      .gallery {
        flex-direction: column-reverse;
      }
      
      .thumbnails {
        flex-direction: row;
        order: 1;
        margin-top: 15px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .buy-now,
      .add-to-basket {
        width: 100%;
      }
    }
</style>

<body>
<main class="product-detail-page">
  <div style="height: 100px; background-color: white;"></div>
  
  <div class="container">
    <% if (product && product._id) { %>
      <div class="product-main">
        <!-- Image Gallery -->
        <div class="gallery">
          <div class="thumbnails" id="thumbnailsContainer">
            <% if (product.variants[0] && product.variants[0].images.length > 0) { %>
              <% product.variants[0].images.forEach((img, index) => { %>
                <img 
                  src="/<%= img %>" 
                  onclick="changeImage(this, '/<%= img %>')" 
                  class="thumbnail <%= index === 0 ? 'active' : '' %>"
                  alt="<%= product.productName %> - Thumbnail <%= index + 1 %>"
                >
              <% }); %>
            <% } else { %>
              <img 
                src="/images/default-product.jpg" 
                onclick="changeImage(this, '/images/default-product.jpg')" 
                class="thumbnail active"
                alt="Default product image"
              >
            <% } %>
          </div>
          <div class="main-image-box">
            <img 
              id="mainImage" 
              src="<%= product.variants[0] && product.variants[0].images[0] ? '/' + product.variants[0].images[0] : '/images/default-product.jpg' %>" 
              alt="<%= product.productName %>"
            >
          </div>
        </div>

        <!-- Product Details -->
        <div class="details">
          <h1><%= product.productName %></h1>
          <p class="short-desc"><%= product.description %></p>

          
<% const firstVariant = product.variants[0]; %>
<% const hasValidDiscount =
     typeof firstVariant.discountPrice === 'number' &&
     firstVariant.discountPrice > 0 &&
     firstVariant.discountPrice < firstVariant.regularPrice; %>

<div class="price-row">
  <p class="price" id="dynamicPrice" data-regular="<%= firstVariant.regularPrice %>" data-discount="<%= hasValidDiscount ? firstVariant.discountPrice : '' %>">
    ₹<%= (hasValidDiscount ? firstVariant.discountPrice : firstVariant.regularPrice).toLocaleString('en-IN') %>
  </p>
  <% if (hasValidDiscount) { %>
    <span class="old-price" id="dynamicOldPrice">
      ₹<%= firstVariant.regularPrice.toLocaleString('en-IN') %>
    </span>
  <% } %>
</div>


          <!-- Stock Info -->
          <div id="stockMessageContainer">
            <% if (firstVariant.quantity <= 0) { %>
              <p class="out-of-stock">Currently out of stock</p>
            <% } else { %>
              <p class="in-stock">In stock</p>
            <% } %>
          </div>

          <!-- Variant Selection -->
          <% if (product.variants.some(v => v.color)) { %>
            <div class="variant-group">
              <label>Colour</label>
              <div class="color-options">
                <% product.variants.forEach((variant, index) => { %>
                  <label>
                    <input 
                      type="radio" 
                      name="color" 
                      value="<%= variant.color %>" 
                      <%= index === 0 ? 'checked' : '' %>
                      <%= variant.quantity <= 0 ? 'disabled' : '' %>
                    />
                    <span class="color-button">
                      <%= variant.color %>
                      <%= variant.quantity <= 0 ? ' (Out of Stock)' : '' %>
                    </span>
                  </label>
                <% }); %>
              </div>
            </div>
          <% } %>

          <% if (product.variants.some(v => v.storage)) { %>
            <div class="variant-group">
              <label>Storage</label>
              <select id="storageSelect" class="storage-select">
                <% product.variants.forEach(variant => { %>
                  <option 
                    value='<%- JSON.stringify(variant) %>'
                    <%= variant.quantity <= 0 ? 'disabled' : '' %>
                  >
                    <%= variant.storage %>
                    <%= variant.quantity <= 0 ? ' (Out of Stock)' : '' %>
                  </option>
                <% }); %>
              </select>
            </div>
          <% } %>

          <!-- Buttons -->
          <div class="action-buttons">
            <button class="buy-now" <%= firstVariant.quantity <= 0 ? 'disabled' : '' %>>
              Buy Now
            </button>
            <button class="add-to-basket" <%= firstVariant.quantity <= 0 ? 'disabled' : '' %>>
              Add to Basket
            </button>
          </div>

          <div class="delivery">
            <p>Dispatched in 5 - 7 weeks</p>
          </div>
        </div>
      </div>

      <!-- Similar Products -->
      <% if (similarProducts && similarProducts.length > 0) { %>
        <div class="similar-products">
          <h2>Similar Products</h2>
          <div class="similar-grid">
            <% similarProducts.forEach(prod => { %>
              <a href="/products/<%= prod._id %>" class="product-link">
                <div class="product-card">
                  <img src="/<%= prod.images[0] || 'images/default-product.jpg' %>" alt="<%= prod.productName %>">
                  <h3 class="name"><%= prod.productName %></h3>
                  <p class="price">
                    ₹<%= prod.variants[0].discountPrice.toLocaleString('en-IN') %>
                    <% if (prod.variants[0].discountPrice < prod.variants[0].regularPrice) { %>
                      <span class="old-price">
                        ₹<%= prod.variants[0].regularPrice.toLocaleString('en-IN') %>
                      </span>
                    <% } %>
                  </p>
                </div>
              </a>
            <% }); %>
          </div>
        </div>
      <% } %>
    <% } else { %>
      <div class="product-not-found">
        <h2>Product not found</h2>
        <p>We couldn't find the product you're looking for.</p>
        <a href="/products" class="btn">Browse Products</a>
      </div>
    <% } %>
  </div>
</main>

<script>
  const variants = <%- JSON.stringify(product.variants) %>;

  function updateGallery(images) {
    const thumbnailsContainer = document.getElementById('thumbnailsContainer');
    const mainImage = document.getElementById('mainImage');
    thumbnailsContainer.innerHTML = '';
    images.forEach((img, idx) => {
      const thumb = document.createElement('img');
      thumb.src = '/' + img;
      thumb.className = 'thumbnail' + (idx === 0 ? ' active' : '');
      thumb.onclick = function() { changeImage(this, '/' + img); };
      thumbnailsContainer.appendChild(thumb);
    });
    mainImage.src = '/' + images[0];
  }

  function changeImage(el, src) {
    document.getElementById('mainImage').src = src;
    document.querySelectorAll('.thumbnail').forEach(img => img.classList.remove('active'));
    el.classList.add('active');
  }

  function updateVariantDetails(variant) {
    const priceDisplay = document.getElementById('dynamicPrice');
    const oldPriceElement = document.querySelector('.old-price');
    priceDisplay.textContent = '₹' + variant.discountPrice.toLocaleString('en-IN');
    
    if (oldPriceElement) oldPriceElement.remove();
    if (variant.discountPrice < variant.regularPrice) {
      const oldPrice = document.createElement('span');
      oldPrice.className = 'old-price';
      oldPrice.textContent = '₹' + variant.regularPrice.toLocaleString('en-IN');
      priceDisplay.parentNode.appendChild(oldPrice);
    }

    updateGallery(variant.images);
    checkStockStatus(variant._id, variant.quantity);
  }

  function getSelectedVariant() {
    const storageSelect = document.getElementById('storageSelect');
    if (storageSelect) {
      try {
        return JSON.parse(storageSelect.value);
      } catch {
        return variants[0];
      }
    }
    return variants[0];
  }

  function checkStockStatus(variantId, quantity) {
    const buyNowBtn = document.querySelector('.buy-now');
    const addToBasketBtn = document.querySelector('.add-to-basket');
    const stockMessageContainer = document.getElementById('stockMessageContainer');
    const isOutOfStock = quantity <= 0;

    buyNowBtn.disabled = isOutOfStock;
    addToBasketBtn.disabled = isOutOfStock;
    stockMessageContainer.innerHTML = isOutOfStock 
      ? '<p class="out-of-stock">Currently out of stock</p>' 
      : '<p class="in-stock">In stock</p>';
  }

  document.addEventListener('DOMContentLoaded', function() {
    const storageSelect = document.getElementById('storageSelect');
    const colorRadios = document.querySelectorAll('input[name="color"]');

    colorRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        const selectedColor = this.value;
        const filteredVariants = variants.filter(v => v.color === selectedColor);
        storageSelect.innerHTML = '';
        filteredVariants.forEach(variant => {
          const option = document.createElement('option');
          option.value = JSON.stringify(variant);
          option.text = variant.storage;
          if (variant.quantity <= 0) option.disabled = true;
          storageSelect.appendChild(option);
        });
        updateVariantDetails(filteredVariants[0]);
      });
    });

    if (storageSelect) {
      storageSelect.addEventListener('change', function() {
        const variant = getSelectedVariant();
        updateVariantDetails(variant);
      });
    }

    updateVariantDetails(variants[0]);
  });

  // Add to Basket
  document.querySelector('.add-to-basket').addEventListener('click', async function() {
    const selectedVariant = getSelectedVariant();
    const quantity = 1;

    this.disabled = true;
    this.textContent = 'Adding...';

    try {
      const response = await fetch('/user-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productId: '<%= product._id %>',
          variantId: selectedVariant._id,
          quantity: quantity
        })
      });

      const result = await response.json();
      if (result.success) {
        const cartCountElement = document.querySelector('.fa-shopping-cart + .cart-count');
        if (cartCountElement) cartCountElement.textContent = result.cartCount;

        Swal.fire({ icon: 'success', title: result.message || 'Added to Cart', timer: 1500 });
      } else {
        Swal.fire({ icon: 'error', title: result.message || 'Error occurred', timer: 1500 });
      }
    } catch (error) {
      Swal.fire({ icon: 'error', title: 'Failed to Add', text: 'Error adding to cart' });
    } finally {
      this.disabled = false;
      this.textContent = 'Add to Basket';
    }
  });
</script>

<%- include('../../views/partials/user/footer') %>
